#include "tunnel.h"

#include "podfather.h"
#include "fb.h"
#include <math.h>

static int scrmap_x[LCD_HEIGHT][LCD_WIDTH];
static int scrmap_y[LCD_HEIGHT][LCD_WIDTH];
static unsigned char pixels[LCD_HEIGHT * LCD_WIDTH];

static int sine[256];

static unsigned char shades[13][4] = {
	{0,0,0,0}, {0,0,0,1}, {1,0,0,1}, {1,0,1,1},
	{1,1,1,1}, {1,1,1,2}, {2,1,1,2}, {2,1,2,2},
	{2,2,2,2}, {2,2,2,3}, {3,2,2,3}, {3,2,3,3},
	{3,3,3,3},
};

/*
static unsigned char texture[16][16] = {
	{1,1,1,1,3,2,2,2,2,2,2,2,0,1,1,1},
	{1,1,1,3,3,3,2,2,2,2,2,0,0,0,1,1},
	{1,1,3,3,3,3,3,2,2,2,0,0,0,0,0,1},
	{1,3,3,3,3,3,3,3,2,0,0,0,0,0,0,0},
	{2,3,3,3,3,3,3,3,1,0,0,0,0,0,0,0},
	{2,2,3,3,3,3,3,1,1,1,0,0,0,0,0,2},
	{2,2,2,3,3,3,1,1,1,1,1,0,0,0,2,2},
	{2,2,2,2,3,1,1,1,1,1,1,1,0,2,2,2},
	{2,2,2,2,0,1,1,1,1,1,1,1,3,2,2,2},
	{2,2,2,0,0,0,1,1,1,1,1,3,3,3,2,2},
	{2,2,0,0,0,0,0,1,1,1,3,3,3,3,3,2},
	{2,0,0,0,0,0,0,0,1,3,3,3,3,3,3,3},
	{1,0,0,0,0,0,0,0,2,3,3,3,3,3,3,3},
	{1,1,0,0,0,0,0,2,2,2,3,3,3,3,3,1},
	{1,1,1,0,0,0,2,2,2,2,2,3,3,3,1,1},
	{1,1,1,1,0,2,2,2,2,2,2,2,3,1,1,1}
};
*/

static unsigned char texture[32][32] = {
	{12, 9, 8, 8, 9, 9,10,10,10,11,11,12,12, 9,12, 9,12, 9,10,10, 9, 9, 8, 8, 8, 7, 7, 6, 6, 9,12, 9},
	{ 7,12, 7, 8, 8, 9, 9,10,11,11,12,12, 7,12, 7, 2, 7,12, 7,10,10, 9, 9, 8, 7, 7, 6, 6, 7,12, 7, 5},
	{ 7, 9,12, 9, 8, 8, 9,10,11,12,12, 9,12, 9, 0, 2, 4, 9,12, 9,10,10, 9, 8, 7, 6, 6, 9,12, 9, 3, 5},
	{ 7, 7, 7,12, 7, 8, 8,10,12,12, 7,12, 7, 0, 0, 2, 4, 4, 7,12, 7,10,10, 8, 6, 6, 7,12, 7, 3, 3, 5},
	{ 6, 7, 7, 9,12, 9, 8,10,12, 9,12, 9, 0, 0, 1, 2, 3, 4, 4, 9,12, 9,10, 8, 6, 9,12, 9, 3, 3, 4, 5},
	{ 6, 6, 7, 7, 7,12, 7,10, 7,12, 7, 0, 0, 1, 1, 2, 3, 3, 4, 4, 7,12, 7, 8, 7,12, 7, 3, 3, 4, 4, 5},
	{ 5, 6, 6, 7, 7, 9,12, 9,12, 9, 0, 0, 1, 1, 2, 2, 2, 3, 3, 4, 4, 9,12, 9,12, 9, 3, 3, 4, 4, 5, 5},
	{ 5, 5, 5, 5, 5, 5, 7,12, 7, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 7,12, 7, 5, 5, 5, 5, 5, 5, 5},
	{ 5, 4, 4, 3, 3, 9,12, 9,12, 9, 4, 4, 3, 3, 2, 2, 2, 1, 1, 0, 0, 9,12, 9,12, 9, 7, 7, 6, 6, 5, 5},
	{ 4, 4, 3, 3, 7,12, 7, 8, 7,12, 7, 4, 4, 3, 3, 2, 1, 1, 0, 0, 7,12, 7,10, 7,12, 7, 7, 7, 6, 6, 5},
	{ 4, 3, 3, 9,12, 9,10, 8, 6, 9,12, 9, 4, 4, 3, 2, 1, 0, 0, 9,12, 9, 8,10,12, 9,12, 9, 7, 7, 6, 5},
	{ 3, 3, 7,12, 7,10,10, 8, 6, 6, 7,12, 7, 4, 4, 2, 0, 0, 7,12, 7, 8, 8,10,12,12, 7,12, 7, 7, 7, 5},
	{ 3, 9,12, 9,10,10, 9, 8, 7, 6, 6, 9,12, 9, 4, 2, 0, 9,12, 9, 8, 8, 9,10,11,12,12, 9,12, 9, 7, 5},
	{ 7,12, 7,10,10, 9, 9, 8, 7, 7, 6, 6, 7,12, 7, 2, 7,12, 7, 8, 8, 9, 9,10,11,11,12,12, 7,12, 7, 5},
	{12, 9,10,10, 9, 9, 8, 8, 8, 7, 7, 6, 6, 9,12, 9,12, 9, 8, 8, 9, 9,10,10,10,11,11,12,12, 9,12, 9},
	{ 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7,12, 7,10,10,10,10,10,10,10,10,10,10,10,10,10, 7,12},
	{12, 9, 6, 6, 7, 7, 8, 8, 8, 9, 9,10,10, 9,12, 9,12, 9,12,12,11,11,10,10,10, 9, 9, 8, 8, 9,12, 9},
	{ 7,12, 7, 6, 6, 7, 7, 8, 9, 9,10,10, 7,12, 7, 5, 7,12, 7,12,12,11,11,10, 9, 9, 8, 8, 7,12, 7, 2},
	{ 0, 9,12, 9, 6, 6, 7, 8, 9,10,10, 9,12, 9, 7, 5, 3, 9,12, 9,12,12,11,10, 9, 8, 8, 9,12, 9, 4, 2},
	{ 0, 0, 7,12, 7, 6, 6, 8,10,10, 7,12, 7, 7, 7, 5, 3, 3, 7,12, 7,12,12,10, 8, 8, 7,12, 7, 4, 4, 2},
	{ 1, 0, 0, 9,12, 9, 6, 8,10, 9,12, 9, 7, 7, 6, 5, 4, 3, 3, 9,12, 9,12,10, 8, 9,12, 9, 4, 4, 3, 2},
	{ 1, 1, 0, 0, 7,12, 7, 8, 7,12, 7, 7, 7, 6, 6, 5, 4, 4, 3, 3, 7,12, 7,10, 7,12, 7, 4, 4, 3, 3, 2},
	{ 2, 1, 1, 0, 0, 9,12, 9,12, 9, 7, 7, 6, 6, 5, 5, 5, 4, 4, 3, 3, 9,12, 9,12, 9, 4, 4, 3, 3, 2, 2},
	{ 2, 2, 2, 2, 2, 2, 7,12, 7, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 7,12, 7, 2, 2, 2, 2, 2, 2, 2},
	{ 2, 3, 3, 4, 4, 9,12, 9,12, 9, 3, 3, 4, 4, 5, 5, 5, 6, 6, 7, 7, 9,12, 9,12, 9, 0, 0, 1, 1, 2, 2},
	{ 3, 3, 4, 4, 7,12, 7,10, 7,12, 7, 3, 3, 4, 4, 5, 6, 6, 7, 7, 7,12, 7, 8, 7,12, 7, 0, 0, 1, 1, 2},
	{ 3, 4, 4, 9,12, 9,12,10, 8, 9,12, 9, 3, 3, 4, 5, 6, 7, 7, 9,12, 9, 6, 8,10, 9,12, 9, 0, 0, 1, 2},
	{ 4, 4, 7,12, 7,12,12,10, 8, 8, 7,12, 7, 3, 3, 5, 7, 7, 7,12, 7, 6, 6, 8,10,10, 7,12, 7, 0, 0, 2},
	{ 4, 9,12, 9,12,12,11,10, 9, 8, 8, 9,12, 9, 3, 5, 7, 9,12, 9, 6, 6, 7, 8, 9,10,10, 9,12, 9, 0, 2},
	{ 7,12, 7,12,12,11,11,10, 9, 9, 8, 8, 7,12, 7, 5, 7,12, 7, 6, 6, 7, 7, 8, 9, 9,10,10, 7,12, 7, 2},
	{12, 9,12,12,11,11,10,10,10, 9, 9, 8, 8, 9,12, 9,12, 9, 6, 6, 7, 7, 8, 8, 8, 9, 9,10,10, 9,12, 9},
	{ 7,10,10,10,10,10,10,10,10,10,10,10,10,10, 7,12, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 7,12}
};

#define TEX_WIDTH 128
#define TEX_HEIGHT 128
#define TEX_SCALE 4

void tunnel_init() {
	int x, y;
	
	int cx = LCD_WIDTH * 3 / 8;
	int cy = LCD_HEIGHT / 8;
	
	double th, r;
	
	int i;
	
	for (i=0; i<256; i++) {
		sine[i] = (int)(0x7fff * sin(i * M_PI / 128));
	}

	for (y = 0; y < LCD_HEIGHT / 2; y++) {
		for (x = 0; x < LCD_WIDTH / 2; x++) {
			th = atan2(x - cx, cy - y);
			r = sqrt((x-cx)*(x-cx) + (y-cy)*(y-cy));
			scrmap_x[y][x] = (int)floor(th * TEX_WIDTH / (2 * M_PI) + TEX_WIDTH) % TEX_WIDTH;
			scrmap_y[y][x] = (int)floor(2500 / (r + 3)) % TEX_HEIGHT;
		}
	}
}

void tunnel_frame(long time) {
	int x, y;
	int pixpos, pixval;
	
	int yoff = time * TEX_WIDTH / 1000;
	int xoff = (sine[(time / 8) & 0xff] + sine[(time / 9) & 0xff]) * (TEX_HEIGHT / 4) >> 16;
	// int xoff = time * TEX_WIDTH / 2000;

	for (y = 0; y < LCD_HEIGHT / 2; y++) {
		for (x = 0; x < LCD_WIDTH / 2; x++) {
			pixpos = y * LCD_WIDTH * 2 + x * 2;
			pixval = texture[((scrmap_y[y][x] + yoff) % TEX_HEIGHT) / TEX_SCALE][((scrmap_x[y][x] + xoff) % TEX_WIDTH) / TEX_SCALE];
			pixels[pixpos] = shades[pixval][0];
			pixels[pixpos + 1] = shades[pixval][1];
			pixels[pixpos + LCD_WIDTH] = shades[pixval][2];
			pixels[pixpos + LCD_WIDTH + 1] = shades[pixval][3];
		}
	}
	
	fb_write(pixels);
}